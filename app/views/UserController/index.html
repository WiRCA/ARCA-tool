<!--
  ~ Copyright (C) 2011 by Eero Laukkanen, Risto Virtanen, Jussi Patana, Juha Viljanen,
  ~ Joona Koistinen, Pekka Rihtniemi, Mika KekÃ¤le, Roope Hovi, Mikko Valjus,
  ~ Timo Lehtinen, Jaakko Harjuhahto
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in
  ~ all copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  ~ THE SOFTWARE.
  -->
#{extends 'main.html' /}
#{set 'title'}&{'user.allCases'}#{/set}
#{set 'pageHeader'}&{'user.welcomeTitle', user.name}#{/set}
#{set 'pageHeaderSmall'}#{/set}

<script src="@{'/public/javascripts/bootstrap-twipsy.js'}" type="text/javascript"
        charset="${_response_encoding}"></script>
<script src="@{'/public/javascripts/bootstrap-popover.js'}" type="text/javascript"
        charset="${_response_encoding}"></script>

<script type="text/javascript">
        $(function () {
        $("a[rel=popover]")
        .popover({
        offset: 10
        })
        })
    </script>
<script type="text/javascript">
    var getRCACaseUsers = #{jsAction @RCACaseController.getUsers(':rcaCaseId') /}
    var inviteUserAction = #{jsAction @RCACaseController.inviteUser(':rcaCaseId', ':invitedEmail') /}
    var removeUserAction = #{jsAction @RCACaseController.removeUser(':rcaCaseId', ':isInvitedUser', ':email') /}

    $(function() {
    $("#rcacase-share-dialog").dialog({
    autoOpen: false,
    height: 400,
    width: 500,
    modal: true,
    buttons: {
    "&{'rcacase.share.dialog.close'}": function() {
    $( this ).dialog( "close" );
    }
    },
    close: function() {
    $("table#rcacase-share-dialog-persons").remove();
    $("#rcacase-share-dialog-invitedEmail-input").val("");
    $("#rcacase-share-dialog-rcaCaseId-input").val("");
    $("#rcacase-share-dialog-invitedEmail-error").hide();
    }
    });

    $("#rcacase-share-dialog-share-form").submit(function() {
    var rcaId = $("#rcacase-share-dialog-rcaCaseId-input").val();
    var email = $("#rcacase-share-dialog-invitedEmail-input").val();

    /* Check if user exists already */
    if ($('#rcacase-share-dialog-persons tr').find('td[name="' + email + '"]').length > 0) {
    $("#rcacase-share-dialog-invitedEmail-input").val("");
    $("#rcacase-share-dialog-invitedEmail-error").hide();
    return false
    }

    $.getJSON(inviteUserAction({rcaCaseId: rcaId, invitedEmail: email}), function(data) {
    if (data.invalidEmail == "true") {
    $("#rcacase-share-dialog-invitedEmail-error").html("&{'rcacase.share.dialog.invalidEmail'}");
    $("#rcacase-share-dialog-invitedEmail-error").show();
    } else {
    var invited = data.invited == "true" ? "invited-" : "";
    $('<tr id="user-' + invited + data.id + '">'+
       '<td>'+data.name+'</td>'+
        '<td name="' + data.email + '">'+data.email+'</td>'+
        '<td><a href="#" style="color:red;" id="remove-user-share">'+
        '&{"rcacase.share.dialog.remove"}'+'</a></td>'+
        '</tr>').appendTo("table#rcacase-share-dialog-persons");
    $("#rcacase-share-dialog-invitedEmail-input").val("");
    $("#rcacase-share-dialog-invitedEmail-error").hide();
    }
    });
    return false;
    });
    });

    $("a[id^='rcacase-share-']").live("click", function () {
    var id = this.id.replace("rcacase-share-", "");
    $.getJSON(getRCACaseUsers({rcaCaseId: id}), function(data) {
    var users = [];
    for (i in data) {
    var user = data[i];
    var removeLink = "${session.username}" == user.email ? "" :
    '<a href="#" style="color:red;" id="remove-user-share">&{"rcacase.share.dialog.remove"}</a>';
    var invited = user.invitedUser == "true" ? "invited-" : "";
    users.push('<tr id="user-' + invited + user.id + '">'+
        '<td>'+user.name+'</td>'+
        '<td name="' + user.email + '">'+user.email+'</td>'+
        '<td>' + removeLink + '</td>'+'</tr>');
    }
    $("<table/>", {'id': 'rcacase-share-dialog-persons',
    'html': "<tr><th>&{'rcacase.share.dialog.name'}</th>" +
        "<th>&{'rcacase.share.dialog.email'}</th>" +
        "<th>&{'rcacase.share.dialog.actions'}</th></tr>"+
    users.join('')
    }).appendTo("#rcacase-share-dialog");

    $("#rcacase-share-dialog-invitedEmail-error").hide();
    $("#rcacase-share-dialog-rcaCaseId-input").val(id);
    $("#rcacase-share-dialog").dialog( "open" );
    var width = $("table#rcacase-share-dialog-persons").width();
    $("#rcacase-share-dialog").dialog( "option", "width", width+100 );
    $("#rcacase-share-dialog").css("height", "auto");
    });
    });

    $("a#remove-user-share").live("click", function() {
    var rcaId = $("#rcacase-share-dialog-rcaCaseId-input").val();
    var email = $(this).parent().prev().html();
    var tr = $(this).parents("tr");
    var trId = $(tr).attr("id");
    var isInvitedUser = trId.indexOf("user-invited-") != -1;
    $.getJSON(removeUserAction({rcaCaseId: rcaId, isInvitedUser: isInvitedUser, email: email}), function(data) {
    if (data.success == "true") {
    $(tr).remove();
    }
    });
    });
</script>

*{TODO: Creation date to links. Modification of mouseovers. Overall layout revamp.}*
<h2>&{'user.myCases'}</h2>
<ul>
    #{list items:ownCases, as:'rcaCase'}
    <li>#{a @RCACaseController.show(rcaCase.id), id:'show-rcacase-'+rcaCase.id+'-link', rel:'popover',
        title:"${rcaCase.caseName}", 'data-content':"${rcaCase.description}"}${rcaCase.caseName}#{/a}
        &{'rcacase.lastmodified'} ${rcaCase.updated.since(true)}
        &{'user.created'} ${rcaCase.created.since(true)}
        <a id="rcacase-share-${rcaCase.id}" href="javascript:;">&{'rcacase.share'}</a>
        #{a @RCACaseController.extractCSV(rcaCase.id)}&{'rcaCase.csv.exportCSV'}#{/a}
    </li>
    #{/list}
    #{else}
    <li>&{'user.noRCACases'}</li>
    #{/else}
</ul>

<h2>&{'user.sharedCases'}</h2>
<ul>
    #{list items:privateCases, as:'rcaCase'}
    <li>#{a @RCACaseController.show(rcaCase.id), id:'show-rcacase-'+rcaCase.id+'-link', rel:'popover',
        title:"${rcaCase.caseName}", 'data-content':"${rcaCase.description}"}${rcaCase.caseName}#{/a}
        &{'rcacase.lastmodified'} ${rcaCase.updated.since(true)}
        &{'user.created'} ${rcaCase.created.since(true)}
    </li>
    #{/list}
    #{else}
    <li>&{'user.noPrivateCases'}</li>
    #{/else}
</ul>

<h2>&{'user.publicCases'}</h2>
<ul>
    #{list items:publicCases, as:'rcaCase'}
    <li>#{a @RCACaseController.show(rcaCase.id), id:'show-rcacase-'+rcaCase.id+'-link', rel:'popover',
        title:"${rcaCase.caseName}", 'data-content':"${rcaCase.description}"}${rcaCase.caseName}#{/a}
        &{'rcacase.lastmodified'} ${rcaCase.updated.since(true)}
        &{'user.created'} ${rcaCase.created.since(true)}
    </li>
    #{/list}
    #{else}
    <li>&{'user.noPublicCases'}</li>
    #{/else}
</ul>

<h2>&{'user.allPublicCases'}</h2>
<ul>
    #{list items:allPublicCases, as:'rcaCase'}
    <li>#{a @RCACaseController.show(rcaCase.id)} ${rcaCase.caseName} #{/a}</li>
    #{/list}
    #{else}
    <li>&{'user.noAnyPublicCases'}</li>
    #{/else}
</ul>

#{a @RCACaseController.createRCACase(), class:'btn primary large'} &{'user.createRCACase'} #{/a}


<div id="rcacase-share-dialog" title="&{'rcacase.share.dialog.title'}">
    #{form @RCACaseController.inviteUser(), id:'rcacase-share-dialog-share-form' }
    <input id="rcacase-share-dialog-rcaCaseId-input" type="hidden" name="rcaCaseId"/>
    <label for="rcacase-share-dialog-invitedEmail-input">&{'rcacase.share.dialog.inviteEmail'}</label>
    <input id="rcacase-share-dialog-invitedEmail-input" type="text" name="invitedEmail"/>
    <span id="rcacase-share-dialog-invitedEmail-error" class="error"></span>
    <input type="submit" value="&{'rcacase.share.dialog.submitForm'}"/>
    #{/form}
    <span>&{'rcacase.share.dialog.whoHasAccess'}</span>
</div>