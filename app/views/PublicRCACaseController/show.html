<!--
  ~ Copyright (C) 2011 by Eero Laukkanen, Risto Virtanen, Jussi Patana, Juha Viljanen, Joona Koistinen, Pekka Rihtniemi, Mika KekÃ¤le, Roope Hovi, Mikko Valjus
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in
  ~ all copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  ~ THE SOFTWARE.
  -->
<!DOCTYPE html>

<html>
    <head>
        <title>&{'showRCACase.title', rcaCase.caseName}</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta charset="${_response_encoding}">
        #{press.stylesheet 'main.css' /}
        #{press.stylesheet 'jquery-ui-1.8.16.custom.css' /}
        #{press.stylesheet 'base.css' /}
        #{press.stylesheet src:'bootstrap.min.css', compressed:false /}
        #{press.stylesheet 'arcaeditor.css' /}
        #{press.compressed-stylesheet /}

        <link rel="shortcut icon" type="image/png" href="@{'/public/images/favicon.png'}">
        <!--[if lt IE 9]>
        <script src="${'/public/javascripts/excanvas.compiled.js'}" type="text/javascript"></script>
        <![endif]-->
        #{press.script src:'jquery-1.7.1.min.js', compress:false /}
        #{press.script 'bootstrap-modal.js' /}
        #{press.script 'bootstrap-twipsy.js' /}
        #{press.script 'bootstrap-popover.js' /}
        #{press.script src:'jquery-ui-1.8.16.custom.min.js', compress:false /}
        #{press.script 'smalljit.js' /}
        #{press.script 'jQuery.radmenu.js' /}
        #{press.compressed-script /}
        
        <script type="text/javascript">
        // Google Analytics
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-28831715-1']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
        </script>
    </head>
    <body>

#{navigation /}

    <div id="help-message" class="alert-message block-message info">
      <a id="help-message-close" class="close" href="#">&times;</a>
      <p><strong>&{'editor.help1'}</strong> &{'editor.help2'}</p>
    </div>
	<div id="relation-help-message" class="alert-message warning">
		<p><strong>&{'editor.addRelationInfo1'}</strong> &{'editor.addRelationInfo2'}</p>
	</div>
    <div id="correction-help-message" class="alert-message success">&{'addCorrectiveAction.success'}</div>
    <div id="infovis">
      
    </div>
  
  <div id="radial_menu" style="position: absolute; display: none; width: 0; height: 0;">
    <ul class="list">
      <li class="item radmenu-button" id="radmenu-event-addCause">
          <a href="#" rel='twipsy' data-placement="right"
             title='&{'editor.addCause'}'>
              <img src="@{'/public/images/icons/add_2.png'}" height="36" width="36" style="margin-left: -8px; margin-top: -8px">
          </a>
      </li>
      <li class="item radmenu-button" id="radmenu-event-addRelation">
          <a href="#" rel='twipsy' data-placement="left" title='&{'editor.addRelation'}'>
              <img src="@{'/public/images/icons/back_1.png'}" height="36" width="36" style="margin-left: -8px; margin-top: -8px">
          </a>
      </li>
      <li class="item radmenu-button"id="radmenu-event-addCorrection" data-controls-modal="modal-from-dom"
          data-backdrop="static">
          <a href="#" rel='twipsy' data-placement="left" title='&{'editor.addCorrection'}'>
              <img src="@{'/public/images/icons/light_bulb.png'}" height="36" width="36" style="margin-left: -8px; margin-top: -8px">
          </a>
      </li>
      <li class="item radmenu-button" id="radmenu-event-removeCause">
          <a href="#" rel='twipsy' data-placement="right" title='&{'editor.delete'}'>
              <img src="@{'/public/images/icons/trash.png'}" height="36" width="36" style="margin-left: -8px; margin-top: -8px">
          </a>
      </li>
      <li class="item radmenu-button" id="radmenu-event-renameCause">
          <a href="#" rel='twipsy' data-placement="right"
             title='&{'editor.renameCause'}'>
              <img src="@{'/public/images/icons/edit.png'}" height="36" width="36" style="margin-left: -8px; margin-top: -8px">
          </a>
    </li>
    </ul>
  </div>
  <!-- Add corrective action popover form div -->
  <script>
    $(function () {
        $("a[rel=twipsy]").twipsy({live: true})

        $('#infovis').live("mousedown", function(event){
            jQuery("#radial_menu").radmenu("hide");
            $('.popover').remove();
            jQuery("#corrections_link").hide();
        });

        $("div[rel=popover]").popover({
          offset: 10,
          html: true
        }).click(function(e) {
          isVisible = true;
          e.preventDefault();
        });

        $("#help-message").delay(5000).fadeOut("slow");
    })
  </script>
  
  <div id="addcorrection-modal" class="modal hide">
    <form action="" onsubmit="addCorrectiveIdea(); return false;" style="margin: 0; padding: 0;">
    <div class="modal-header">
      <a href="#" class="close">&times;</a>
      <h3>&{'addCorrectiveAction.title'}</h3>
    </div>
    <table>
      <tr>
        <td>
          <div id="ideaHeader">
            <b>&{'addCorrectiveAction.ideaHeader'}</b>
          </div>
          <div id="my_modal_body">

          </div>
        </td>
        <td>
          <div class="modal-body">
            <div class="clearfix">
              <label for="ideaName">&{'addCorrectiveAction.name'}</label>
              <div class="input">
                <input type="text" id="ideaName" />
              </div>
            </div>
            <div class="clearfix">
              <label for="ideaDescription">&{'addCorrectiveAction.description'}</label>
              <div class="input">
                <textarea rows="3" id="ideaDescription"></textarea>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </table>
    <div class="modal-footer">
      <input id="submitCorrectiveActionButton" class="btn primary"type="submit" value="&{'addCorrectiveAction.submit'}"/>
      <a href="#" class="btn secondary" onclick="$('#addcorrection-modal').modal('hide')">&{'dialog.cancel'}</a>
    </div>
    </form>
  </div>

<div id="addcause-modal" class="modal hide">
        <div class="modal-header">
            <a href="#" class="close">&times;</a>
            <h3>&{'addCause.title'}</h3>
        </div>
        <form action="" onsubmit="addNewCause(); return false;" style="margin: 0; padding: 0;">
            <div class="modal-body">
                <div class="clearfix">
                    <label for="causeName">&{'addCause.name'}</label>
                    <div class="input">
                        <input class="xlarge" autofocus="autofocus" id="causeName" name="causeName" type="text" value="" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <input type="submit" value="&{'addCause.title'}" class="btn primary" id="addcause-submit" />
                <a href="#" class="btn secondary" onclick="$('#addcause-modal').modal('hide')">&{'dialog.cancel'}</a>
            </div>
        </form>
</div>
<script type="text/javascript">
    function addNewCause() {
        var addCauseAjax = #{jsAction @CauseController.addCause(':causeId', ':name') /};
        var name = $.trim($("#causeName").val());
	    if (name == undefined || name == "") {
	      $("#causeName").parents(".clearfix").addClass("error");
	      return;
	    } else {
	      $("#causeName").parents(".clearfix").removeClass("error");
	    }
        radmenu_fadeOut();
        $("#addcause-modal").modal('hide');
        $.post(addCauseAjax({causeId: globalSelectedNode, name: encodeURIComponent(name)}));
    };
</script>

<div id="renameCause-modal" class="modal hide">
    <div class="modal-header">
        <a href="#" class="close">&times;</a>
        <h3>&{'renameCause.title'}</h3>
    </div>
    <form action="" onsubmit="renameCause(); return false;" style="margin: 0; padding: 0;">
        <div class="modal-body">
            <div class="clearfix">
                <label for="renamedName">&{'renameCause.newName'}</label>
                <div class="input">
                    <input class="xlarge" autofocus="autofocus" id="renamedName"
                           name="renamedName" type="text" value="" />
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <input type="submit" value="&{'renameCause.title'}" class="btn primary" id="renameCause-submit" />
            <a href="#" class="btn secondary" onclick="$('#renameCause-modal').modal('hide')">&{'dialog.cancel'}</a>
        </div>
    </form>
</div>
<script type="text/javascript">
    function renameCause() {
        var renameCauseAjax = #{jsAction @CauseController.renameCause(':causeId', ':name') /};
        var name = $.trim($("#renamedName").val());
        if (name == undefined || name == "") {
	      $("#renamedName").parents(".clearfix").addClass("error");
	      return;
	    } else {
	      $("#renamedName").parents(".clearfix").removeClass("error");
	    }
        radmenu_fadeOut();
        $("#renameCause-modal").modal('hide');
        $.post(renameCauseAjax({causeId: globalSelectedNode, name: encodeURIComponent(name)}));
    };
</script>

<script type="text/javascript">
  function addCorrectiveIdea() {
    var addCorrection = #{jsAction @CauseController.addCorrection(':toId', ':name', ':description') /}
    var name = $("#ideaName").val();
    if (name == undefined || name == "") {
      $("#ideaName").parents(".clearfix").addClass("error");
      return;
    } else {
      $("#ideaName").parents(".clearfix").removeClass("error");
    }
    var description = $("#ideaDescription").val();
    if (description == undefined || description == "") {
      $("#ideaDescription").parents(".clearfix").addClass("error");
      return;
    } else {
      $("#ideaDescription").parents(".clearfix").removeClass("error");
    }
    $.post(addCorrection({toId: globalSelectedNode, name: name, description: description}), function (data) {
      radmenu_fadeOut();
      $("#addcorrection-modal").modal('hide');
      $("#correction-help-message").show();
      $("#correction-help-message").delay(1700).fadeOut(1600, "linear");
    });
  };
  
    function applyZoom() {
        var nodes = $("#infovis-label div.node");
        nodes.css("-webkit-transform", "scale(" + zoomLevel + ")");
        nodes.css("-moz-transform",  "scale(" + zoomLevel + ")");
        nodes.css("-ms-transform",  "scale(" + zoomLevel + ")");
        nodes.css("-o-transform",  "scale(" + zoomLevel + ")");
        nodes.css("transform",  "scale(" + zoomLevel + ")");
    };

    $(document).ready(function() {
			$("#help-message-close").click(function() {
				$(this).parent().hide();
			});
      init();
      zoomLevel = 1;
      $("#correction-help-message").hide();
      $("#relation-help-message").hide();
      $("#addCorrectiveForm").hide();
      $("#ideaHeader").hide();
      $("#infovis").disableSelection();

      // initialize addCause modal window
      $('#addcause-modal').modal({
          keyboard: true,
          backdrop: true,
          show: false
      });
      $('#addcause-modal').bind('show', function () {
          $('#causeName').val('');
      });
      $('#addcause-modal').bind('shown', function () {
          $('#causeName').focus();
      });

      // initialize renameCause modal window
      $('#renameCause-modal').modal({
           keyboard: true,
           backdrop: true,
           show: false
      });
      $('#renameCause-modal').bind('shown', function () {
          $('#renamedName').focus();
      });


      // initialize addCorrection modal window
      $('#addcorrection-modal').modal({
          keyboard: true,
          backdrop: true,
          show: false
      });
      $('#addcorrection-modal').bind('show', function () {
          $('#ideaName').val('');
      });
      $('#addcorrection-modal').bind('show', function () {
          $('#ideaDescription').val('');
      });
      $('#addcorrection-modal').bind('shown', function () {
          $('#ideaName').focus();
      });
      
    });
    var labelType, useGradients, nativeTextSupport, animate;

    (function() {
      var ua = navigator.userAgent,
          iStuff = ua.match(/iPhone/i) || ua.match(/iPad/i),
          typeOfCanvas = typeof HTMLCanvasElement,
          nativeCanvasSupport = (typeOfCanvas == 'object' || typeOfCanvas == 'function'),
          textSupport = nativeCanvasSupport
            && (typeof document.createElement('canvas').getContext('2d').fillText == 'function');
      //I'm setting this based on the fact that ExCanvas provides text support for IE
      //and that as of today iPhone/iPad current text support is lame
      labelType = (!nativeCanvasSupport || (textSupport && !iStuff))? 'Native' : 'HTML';
      nativeTextSupport = labelType == 'Native';
      useGradients = nativeCanvasSupport;
      animate = !(iStuff || !nativeCanvasSupport);
    })();

    (function($){

        $.fn.disableSelection = function() {
            return this.each(function() {
                $(this).attr('unselectable', 'on')
                        .css({'-moz-user-select':'none',
                                 '-o-user-select':'none',
                                 '-khtml-user-select':'none',
                                 '-webkit-user-select':'none',
                                 '-ms-user-select':'none',
                                 'user-select':'none'})
                        .each(function() {
                                  $(this).attr('unselectable','on')
                                          .bind('selectstart',function(){ return false; });
                              });
            });
        };

    })(jQuery);

    function init(){
      // init data
      var json = [
        #{list rcaCase.causes, as:'cause'}
          {
            "id": "${cause.id}",
            "name": "${cause.name}",
            "data": {
                    "hasCorrections": ${!cause.corrections.isEmpty()},
                    "$type": "circle",
                    "$dim":1,
                    "parent": #{if cause.parent}${cause.parent.id}#{/if}#{else}""#{/else},
                    "creatorId": '${cause.creatorId}',
                    "xCoordinate": #{if cause.xCoordinate != null && rcaCase.problem != cause}${cause.xCoordinate}#{/if}#{else}""#{/else},
                    "yCoordinate": #{if cause.yCoordinate != null && rcaCase.problem != cause}${cause.yCoordinate}#{/if}#{else}""#{/else}
                    },
            "adjacencies": [
            #{list cause.causes, as:'causedBy'}
            {
              nodeTo: "${causedBy.id}"
            }${causedBy_isLast && !cause.relations ? '' : ','}
            #{/list}
            #{list cause.relations, as:'relation'}
            {
              "nodeTo": "${relation.id}",
              "data": {  
                  "$type":"arrow",  
                  "$direction": ["${cause.id}", "${relation.id}"],  
                  "$dim":30,  
                  "$color":"#FF0000",  
                  "weight": 1  
              }
            }${relation_isLast ? '' : ','}
            #{/list}
            ]
          }${cause_isLast ? '' : ','}
        #{/list}
      ];

      var lastReceived = ${lastMessage};
      var waitMessages = #{jsAction @waitMessages(rcaCase.id,':lastReceived') /}
      var deleteCause = #{jsAction @CauseController.deleteCause(':causeId') /}
      var addRelation = #{jsAction @CauseController.addRelation(':fromId', ':toID') /}
      var moveNode = #{jsAction @CauseController.nodeMoved(':causeId', ':x', ':y') /}
      // end
      var $radial_menu = $("#radial_menu"), menupos, menuwidth, selectedNode, relationFromNode;
      
      jQuery("#radial_menu").radmenu({
        listClass: 'list', // the list class to look within for items
        itemClass: 'item', // the items - NOTE: the HTML inside the item is copied into the menu item
        radius: 50, // radius in pixels
        animSpeed: 2000, // animation speed in millis
        centerX: -5, // the center x axis offset
        centerY: -10, // the center y axis offset
        selectEvent: "click", // the select event (click)
        onSelect: function($selected){ // show what is returned
					$('.twipsy').remove();
            if($selected[0].id == "radmenu-event-removeCause"){
              $.post(deleteCause({causeId: selectedNode.id}));
              jQuery("#radial_menu").radmenu("hide");
            }
            else if($selected[0].id == "radmenu-event-renameCause"){
                $('#renamedName').val(selectedNode.name);
                $('#renameCause-modal').modal('show');
                globalSelectedNode = selectedNode.id;
            }
            else if($selected[0].id == "radmenu-event-addCause"){
                $('#addcause-modal').modal('show');
                globalSelectedNode = selectedNode.id;
            }
            else if($selected[0].id == "radmenu-event-addRelation"){
              relationFromNode = selectedNode;
			  $("#relation-help-message").show();
              radmenu_fadeOut();
              defaultEdgesForSelectedNode(selectedNode);
            }
            else if($selected[0].id == "radmenu-event-addCorrection") {
              var $modal_body = $("#my_modal_body");
              var getCorrectionNames = #{jsAction @CauseController.getCorrectionNames(':causeId') /}
              $.get(getCorrectionNames({causeId: selectedNode.id}), function(data) {
                $modal_body.html(" ");
                if (data != "") {
                  $("#ideaHeader").show();
                  $modal_body.append("<ul>");
                  for (var i = 0; i < data.length; i++) {
                      $modal_body.append("<li>"+data[i]+"</li>");
                  }
                  $modal_body.append("</ul>");
                }else {
                  $("#ideaHeader").hide();
                };
              });
              $('#addcorrection-modal').modal('show');
              globalSelectedNode = selectedNode.id;
            }
          },
        angleOffset: 45 // in degrees
      });
      function show_radial_menu(given_node){

        selectedNode = given_node;
		if(given_node.id == ${rcaCase.problem.id}){
			$("#" + given_node.id).addClass("rootNodeBoxSelected");
		}
		else{
			$("#" + given_node.id).addClass("nodeBoxSelected");
		}
		
        //get the position of the placeholder element
        menupos   = $("#"+given_node.id).offset();
        menuwidth = $("#"+given_node.id).width();
		menuheight = $("#"+given_node.id).height();

		isFirefox = 0; // this is 1 if Firefox is used.
		isChrome = 0; // this is 1 if Chrome or Safari is used.
		isIE = 0; // this is 1 if IE is used.
		
		// checks the browser
		if($.browser.mozilla){isFirefox = 1;}
		else if($.browser.msie){isIE = 1;}
		else {isChrome = 1;}
		
		//border radius needs to be concerned while calculating height and width for a node
		halfNodeWidth = isChrome*((menuwidth/2)*zoomLevel-10) + isFirefox*(menuwidth/2-10) + isIE*((menuwidth/2)*zoomLevel-10);
		halfNodeHeight = isChrome*((menuheight/2)*zoomLevel-20) + isFirefox*(menuheight/2-20) + isIE*((menuheight/2)*zoomLevel-20);
		
		//radius algorithm depends on amount of menu items in radial menu
		if(menuheight > menuwidth){
			newRadius = halfNodeHeight + 60;
		}
		else {
			newRadius = halfNodeWidth + 30;
		}
		jQuery("#radial_menu").radmenu("opts").radius = newRadius;

		 //show the menu directly over the placeholder
        $radial_menu.css({ "left": menupos.left + halfNodeWidth + "px", "top": menupos.top + halfNodeHeight + "px" }).show();
        radmenu_fadeIn(selectedNode);
        $("#radial_menu").disableSelection();
      }

       $("#infovis").css("width", window.innerWidth + 1000);
       $("#infovis").css("height", window.innerHeight + 1000);

      // init ForceDirected
      var fd = new $jit.ForceDirected({
        //id of the visualization container
        injectInto: 'infovis',
        'width': window.innerWidth + 1000,
        'height':window.innerHeight + 1000,
        //Enable zooming and panning
        //by scrolling and DnD
        Navigation: {
          enable: true,
          //Enable panning events only if we're dragging the empty
          //canvas (and not a node).
          panning: 'avoid nodes',
          zooming: 50 //zoom speed. higher is more sensible
        },
        // Change node and edge styles such as
        // color and width.
        // These properties are also set per node
        // with dollar prefixed data-properties in the
        // JSON structure.
        Node: {
          overridable: true,
          color: "#83548B",
          dim:1
        },
        Edge: {
          overridable: true,
          type: 'line',
          dim: 15,
          color: '#23A4FF',
          lineWidth: 2
        },
        //Native canvas text styling
        Label: {
          type: 'HTML', //Native or HTML
          size: 10,
          style: 'bold'

        },
        //Add Tips
        Tips: {
          enable: false
        },
        // Add node events
        Events: {
          enable: true,
          //Change cursor style when hovering a node
          onMouseEnter: function() {
            fd.canvas.getElement().style.cursor = 'move';
          },	
          onMouseLeave: function() {
            fd.canvas.getElement().style.cursor = '';
          },
          //Update node positions when dragged
          onDragMove: function(node, eventInfo, e) {
            jQuery("#radial_menu").radmenu("hide");
            var pos = eventInfo.getPos();
            node.pos.setc(pos.x, pos.y);
            node.setPos(new $jit.Complex(pos.x, pos.y), 'end');
            fd.plot();
          },
          onDragEnd: function(node, eventInfo, e){
            var nodeParent = fd.graph.getNode(node.data.parent);
            if (nodeParent != undefined) {
              var xPos = node.getPos('end').x - nodeParent.getPos('end').x;
              var yPos = node.getPos('end').y - nodeParent.getPos('end').y;
              $.post(moveNode({causeId: node.id, x: xPos, y: yPos}));
              updateChildrenVectors(node);
            }
          },
          //Implement zooming for nodes
          onMouseWheel: function(delta, e) {
            var zoom = (fd.config.Navigation.zooming / 1000 * delta) + 1;
            zoomLevel = zoomLevel * zoom;

            //hides a radial menu when zoomed as the scaling does not work yet.
            jQuery("#radial_menu").radmenu("hide");
            $('.popover').remove();
            applyZoom();
          },
          //Implement the same handler for touchscreens
          onTouchMove: function(node, eventInfo, e) {
            $jit.util.event.stop(e); //stop default touchmove event
            this.onDragMove(node, eventInfo, e);
          },
          //Add also a click handler to nodes
          onClick: function(node){
			$("#help-message").hide();
            if(node){
              if (relationFromNode) {
                $.post(addRelation({fromId: relationFromNode.id, toID: node.id}));
                relationFromNode = null;
				$("#relation-help-message").fadeOut(500, "linear");
              }
              else {
                defaultEdgesForSelectedNode(selectedNode);
                jQuery("#corrections_link").fadeOut(400);
                show_radial_menu(node);
                node.eachAdjacency(function(adj) {
                  adj.setDataset('current', {
                    lineWidth: '5',
                    color: '#4CC417'
                  });
                });
                fd.plot();
              }
            } else{
              defaultEdgesForSelectedNode(selectedNode);
              jQuery("#radial_menu").radmenu("hide");
              jQuery("#corrections_link").fadeOut(400);
              $("#addCorrectiveForm").popover('hide');
              fd.plot();
            }
          },
          },

        //Number of iterations for the FD algorithm
        iterations: 0,
        //Edge length
        levelDistance: 0,
        // Add text to the labels. This method is only triggered
        // on label creation and only for DOM labels (not native canvas ones).
        onCreateLabel: function(domElement, node){
        // Root node looks different.
        if (node.id == ${rcaCase.problem.id}) {
          $(domElement).addClass('rootNodeBox');
        }
        else {
          $(domElement).addClass('nodeBox');
        }
          $(domElement).html(node.name);
          if(node.data.hasCorrections) {
            $(domElement).addClass('nodeBoxCorrection');
          }
        },
        // Change node styles when DOM labels are placed
        // or moved.
        onPlaceLabel: function(domElement, node){
          var style = domElement.style;
          var left = parseInt(style.left);
          var top = parseInt(style.top);
          var w = parseInt(domElement.offsetWidth) >> 1;
          var h = parseInt(domElement.offsetHeight) >> 1;
          style.left = (left - w) + 'px';
          style.top = (top - h) + 'px';
        }
      });
      var getNodes = function() {
          $.ajax({
                url: waitMessages({lastReceived: lastReceived}),
                success: function(events) {
                    $(events).each(function() {
                        if (this.data.type === 'deletecauseevent') {													
                          fd.graph.removeNode(this.data.causeId);
                          fd.plot();
                          $("div.node#" + this.data.causeId).remove();
                        }
                        if (this.data.type === 'addrelationevent') {
                          //alert(this.data.causeFrom + " " + this.data.causeTo);
                          fd.graph.addAdjacence(fd.graph.getNode(this.data.causeFrom), fd.graph.getNode(this.data.causeTo), {  
                              "$type":"arrow",  
                              "$direction": [this.data.causeFrom, this.data.causeTo],  
                              "$dim":30,  
                              "$color":"#FF0000",  
                              "weight": 1  
                          });
                          
                          fd.plot();
                        }
                        if (this.data.type === 'addcorrectionevent') {
                          //alert(this.data.correctionTo + " " + this.data.name);
                          $("#"+this.data.correctionTo).addClass('nodeBoxCorrection');
                          fd.plot();
                        }
                        else if(this.data.type === 'addcauseevent') {
                          // This is a small fix. Now twipsy hides as it's supposed to.
                          // $('.twipsy').remove();
                          defaultEdgesForSelectedNode(selectedNode);
                          var newNode = {
                            "id": this.data.causeTo,
                            "name": this.data.text,
                            "data": {
                                "parent": this.data.causeFrom,
                                "creatorId": ''+this.data.creatorId
                            }
                          };
                          var oldNode = fd.graph.getNode(this.data.causeFrom);
                          var newNodesXCoordinate = 100;
                          var newNodesYCoordinate = 100;
                          fd.graph.addAdjacence(oldNode,newNode);
                          newNode = fd.graph.getNode(this.data.causeTo);
                          newNode.data.nodeLevel = oldNode.data.nodeLevel+1;
                          newNode.setPos(oldNode.getPos('end'),'current');
                          newNode.getPos('end').y = oldNode.getPos('end').y + newNodesYCoordinate;
						  newNode.getPos('end').x = oldNode.getPos('end').x + newNodesXCoordinate;
                          newNode.data.xCoordinate = newNodesXCoordinate;
                          newNode.data.yCoordinate = newNodesYCoordinate;
                          fd.plot();
                          fd.animate({
                            modes: ['linear'],
                            transition: $jit.Trans.Elastic.easeOut,
                            duration: 1500
                          });
                          applyZoom();
                            $("#infovis-label div.node").disableSelection();
                        }
                        else if(this.data.type === 'causeRenameEvent') {
                            var oldNode = fd.graph.getNode(this.data.causeId);
                            oldNode.name = this.data.newName;
                            $("#" + this.data.causeId).html(this.data.newName);
                        }
                        else if(this.data.type === 'nodemovedevent'){
                          var nodeToMove = fd.graph.getNode(this.data.causeId);
                          var nodeParent = fd.graph.getNode(nodeToMove.data.parent);
                          var intX = parseInt(this.data.x);
                          var intY = parseInt(this.data.y);
                          nodeToMove.data.xCoordinate = intX;
                          nodeToMove.data.yCoordinate = intY;
                          var xPos = nodeParent.getPos('end').x + intX;
                          var yPos = nodeParent.getPos('end').y + intY;
                          var nodePos = new $jit.Complex(xPos,yPos);
                          nodeToMove.setPos(nodePos, 'end');

                          updateChildrenVectors(nodeToMove);
                          fd.animate({
                            modes: ['linear'],
                            transition: $jit.Trans.Elastic.easeOut,
                            duration: 900
                          });
                        }
                        lastReceived = this.id
                    })
                    getNodes()
                },
                dataType: 'json'
          });
      }
      getNodes();

      // load JSON data.
      fd.loadJSON(json);
      fd.plot();
      // compute positions.
      function countParentNodes(node){
          if(node){
            return countParentNodes(fd.graph.getNode(node.data.parent))+1;
          }else{
            return 0;
          }
      };
      var rootNode;
      //First calculate levels (y-coordinates) for nodes.
      fd.graph.eachNode(function(node){
        var nodeLevel;
        if(node.data.parent){
          nodeLevel = countParentNodes(node);
        }else{
          rootNode = node;
          nodeLevel = 1;
        }
        node.data.nodeLevel = nodeLevel;
        node.setPos(new $jit.Complex(0, -300 + nodeLevel*80), 'current');
        node.setPos(new $jit.Complex(0, -300 + nodeLevel*80), 'end');
      });
      traverseWholeTree(rootNode);
      fd.animate({
        modes: ['linear'],
        transition: $jit.Trans.Elastic.easeOut,
        duration: 1500
      });

    }
    traverseWholeTree = function(node){
      placeChildsFromParent(node);
      node.eachAdjacency(function(adj) {
        if(adj.nodeTo.data.nodeLevel>node.data.nodeLevel){
          traverseWholeTree(adj.nodeTo);
        }
      });
    }

    placeChildsFromParent = function(nodeFrom){
      var childrens = [];
      var childrensWidth = 0;
      //count children
      nodeFrom.eachAdjacency(function(adj) {
        if(adj.data.$type != "arrow" &&
				adj.nodeTo.data.nodeLevel>nodeFrom.data.nodeLevel && !(adj.nodeTo.data.locked)){
          childrens.push(adj.nodeTo);
          childrensWidth += $("#"+adj.nodeTo.id).width()+25;
        }
      });
      childrensWidth -= 25;
      //left-most side position for nodes
      var nodePos = nodeFrom.getPos('end');
      var leftSideX = nodePos.x-childrensWidth/2;
      //place them
      var runningWidth = 0;
      var iChildsWidth = 0;
      for(var i = 0; i < childrens.length; ++i){
        if(childrens[i].data.xCoordinate!=="" || childrens[i].data.yCoordinate!==""){
          childrens[i].setPos(new $jit.Complex(nodePos.x+childrens[i].data.xCoordinate,nodePos.y+childrens[i].data.yCoordinate), 'end');
        }else{
          iChildsWidth = $("#"+childrens[i].id).width();
          childrens[i].setPos(new $jit.Complex(leftSideX + runningWidth + iChildsWidth/2, childrens[i].getPos('end').y), 'end');
          runningWidth += iChildsWidth+25;
        }
      }
    }

    updateChildrenVectors = function(node) {
      node.eachAdjacency(function(adj) {
        if(adj.data.$type != "arrow" &&
                adj.nodeTo.data.nodeLevel>node.data.nodeLevel && !(adj.nodeTo.data.locked)){
          var xAdjPos = node.getPos('end').x + adj.nodeTo.data.xCoordinate;
          var yAdjPos = node.getPos('end').y + adj.nodeTo.data.yCoordinate;
          adj.nodeTo.pos.setc(xAdjPos, yAdjPos);
          adj.nodeTo.setPos(new $jit.Complex(xAdjPos, yAdjPos), 'end');
          updateChildrenVectors(adj.nodeTo);
        }
      });
    }

    radmenu_fadeIn = function(selectedNode) {
        jQuery("#radial_menu").radmenu("show",
            function(items){
                items.fadeIn(400);

                if ( selectedNode.id == ${rcaCase.problem.id} ||
                    !( selectedNode.data.creatorId == ${currentUser == null ? 'null' : currentUser.id} ||
                    ${currentUser == null ? 'null' : currentUser.id} == ${rcaCase.ownerId})
                    ) {
                    // hide remove-cause button, if user has no rights to remove selected cause
                    jQuery("#radial_menu").radmenu("items")[3].style.visibility = "hidden";

                    // hide rename-cause button, if user has no rights to rename selected cause
                    jQuery("#radial_menu").radmenu("items")[4].style.visibility = "hidden";
                }
            }
        );
    }

    radmenu_fadeOut = function() {
        jQuery("#radial_menu").radmenu("hide",
            function(items){
            items.fadeOut(4000);
            }
        );
    }

    defaultEdgesForSelectedNode = function(selectedNode) {
      if (selectedNode != undefined) {
			if(selectedNode.id == ${rcaCase.problem.id}){
				$("#" + selectedNode.id).removeClass("rootNodeBoxSelected").addClass("rootNodeBox");
			}
			else{
				$("#" + selectedNode.id).removeClass("nodeBoxSelected").addClass("nodeBox");
			}
        selectedNode.eachAdjacency(function(adj) {
          if(adj.data.$type == "arrow") {
            adj.setDataset('current', {
              lineWidth: '2',
              color: '#F00000'
            })
          }else
          adj.setDataset('current', {
            lineWidth: '2',
            color: '#23A4FF'
          });
        });
      }
    }
    
</script>
    </body>
</html>
