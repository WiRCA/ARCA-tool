<!--
  ~ Copyright (C) 2011 by Eero Laukkanen, Risto Virtanen, Jussi Patana, Juha Viljanen, Joona Koistinen, Pekka Rihtniemi, Mika KekÃ¤le, Roope Hovi, Mikko Valjus
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in
  ~ all copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  ~ THE SOFTWARE.
  -->
<!DOCTYPE html>

<html>
    <head>
        <title>#{get 'showRCACase.title' /}</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta charset="${_response_encoding}">
        <link rel="stylesheet" media="screen" href="@{'/public/stylesheets/main.css'}">
        <link rel="stylesheet" media="screen" href="@{'/public/stylesheets/jquery-ui-1.8.16.custom.css'}">
        <link rel="stylesheet" href="@{'/public/stylesheets/screen.css'}" type="text/css" media="screen, projection">
        <link rel="stylesheet" media="screen" href="@{'/public/stylesheets/arcaeditor.css'}">
        <link rel="stylesheet" media="screen" href="@{'/public/stylesheets/base.css'}">
        <link rel="stylesheet" media="screen" href="@{'/public/stylesheets/ForceDirected.css'}">
        <!--[if lt IE 8]>
          <link rel="stylesheet" href="@{'/public/stylesheets/ie.css'}" type="text/css" media="screen, projection">
        <![endif]-->
        #{get 'moreStyles' /}
        <link rel="shortcut icon" type="image/png" href="@{'/public/images/favicon.png'}">
        <script src="@{'/public/javascripts/jquery-1.6.4.min.js'}" type="text/javascript" charset="${_response_encoding}"></script>
        <script src="@{'/public/javascripts/jquery-ui-1.8.16.custom.min.js'}" type="text/javascript" charset="${_response_encoding}"></script>
        <script src="@{'/public/javascripts/smalljit.js'}" type="text/javascript" charset="${_response_encoding}"></script>
        <script src="@{'/public/javascripts/jQuery.radmenu.js'}" type="text/javascript" charset="${_response_encoding}"></script>
        #{get 'moreScripts' /}
    </head>
    <body>
*{
<h1>&{'showRCACase.title', rcaCase.name}</h1>

<p>&{'createRCA.caseName'}: ${rcaCase.name}</p>
<p>&{'createRCA.rcaCaseType'}: ${type}</p>
<p>&{'createRCA.company'}: ${rcaCase.companyName}</p>
<p>&{'createRCA.companySize'}: ${size}</p>
<p>&{'createRCA.multinational'}: ${rcaCase.isMultinational}</p>
<p>&{'createRCA.public'}: ${rcaCase.isCasePublic}</p>
<p>&{'showRCACase.owner'}: ${rcaCase.owner.name}</p>

#{a @UserController.index() } &{'showRCACase.back'} #{/a}
}*
<div id="container">
  <div id="center-container">
    <div id="infovis">
    </div>
  </div>
</div>
  <div id="radial_menu" style="position: absolute; display: none;">
    <ul class="list">
      <li class="item my_class" id="radmenu-event-addCause">+</li>
      <li class="item my_class" id="radmenu-event-addRelation">R</li>
      <li class="item my_class">?</li>
        *{ #{if current == rcaCase.getOwner() || current == cause.creator } }*
      <li class="item my_class" id="radmenu-event-removeCause">X</li>
        *{ #{/if} }*
    </ul>
  </div>

<script type="text/javascript">
    $(document).ready(function() {
      init();
    });
    var labelType, useGradients, nativeTextSupport, animate;

    (function() {
      var ua = navigator.userAgent,
          iStuff = ua.match(/iPhone/i) || ua.match(/iPad/i),
          typeOfCanvas = typeof HTMLCanvasElement,
          nativeCanvasSupport = (typeOfCanvas == 'object' || typeOfCanvas == 'function'),
          textSupport = nativeCanvasSupport
            && (typeof document.createElement('canvas').getContext('2d').fillText == 'function');
      //I'm setting this based on the fact that ExCanvas provides text support for IE
      //and that as of today iPhone/iPad current text support is lame
      labelType = (!nativeCanvasSupport || (textSupport && !iStuff))? 'Native' : 'HTML';
      nativeTextSupport = labelType == 'Native';
      useGradients = nativeCanvasSupport;
      animate = !(iStuff || !nativeCanvasSupport);
    })();

    function init(){
      // init data
      var json = [
        #{list rcaCase.causes, as:'cause'}
          {
            "id": ${cause.id},
            "name": "${cause.name}",
            "data": {"$color": "#83548B","$type": "circle","$dim":1, "parent":
            #{if cause.parent}
            ${cause.parent.id}
            #{/if}
            #{else}
            ""
            #{/else}
            },
            "adjacencies": [
            #{list cause.causes, as:'causedBy'}
            {
              nodeTo: "${causedBy.id}"
            }${causedBy_isLast && !cause.relations ? '' : ','}
            #{/list}
            #{list cause.relations, as:'relation'}
            {
              nodeTo: "${relation.id}"
            }${relation_isLast ? '' : ','}
            #{/list}
            ]
          }${cause_isLast ? '' : ','}
        #{/list}
      ];
      //Running number for creating nodes
      var runningNumber = 0;
      var lastReceived = ${lastMessage};
      var waitMessages = #{jsAction @waitMessages(rcaCase.id,':lastReceived') /}
      var addCause = #{jsAction @CauseController.addCause(':causeId', ':name') /}
      var deleteCause = #{jsAction @CauseController.deleteCause(':causeId') /}
      var addRelation = #{jsAction @CauseController.addRelation(':fromId', ':toID') /}
      // end
      var $radial_menu = $("#radial_menu"), menupos, menuwidth, selectedNode, relationFromNode;
      jQuery("#radial_menu").radmenu({
        listClass: 'list', // the list class to look within for items
        itemClass: 'item', // the items - NOTE: the HTML inside the item is copied into the menu item
        radius: 55, // radius in pixels
        animSpeed: 2000, // animation speed in millis
        centerX: 0, // the center x axis offset
        centerY: -10, // the center y axis offset
        selectEvent: "click", // the select event (click)
        onSelect: function($selected){ // show what is returned 
            if($selected[0].id == "radmenu-event-removeCause"){
              $.post(deleteCause({causeId: selectedNode.id}));
              jQuery("#radial_menu").radmenu("hide");
            }else if($selected[0].id == "radmenu-event-addCause"){
              var name = prompt('Node name?');
              runningNumber = runningNumber + 1;
              if (name != null && name != "") {
                $.post(addCause({causeId: selectedNode.id, name: name}), function() {
                    radmenu_fadeOut();
                });
              }
            }else if($selected[0].id == "radmenu-event-addRelation"){
              relationFromNode = selectedNode;
              radmenu_fadeOut();
            }
          },
        angleOffset: 45 // in degrees
      });
      function show_radial_menu(given_node){
        selectedNode = given_node;
        //get the position of the placeholder element
          menupos   = $("#"+given_node.id).offset();
          menuwidth = $("#"+given_node.id).width();
          //show the menu directly over the placeholder
          $radial_menu.css({ "left": (menupos.left + menuwidth/2 - 20) + "px", "top":menupos.top + "px" }).show();
          radmenu_fadeIn();
      }
      // init ForceDirected
      var fd = new $jit.ForceDirected({
        //id of the visualization container
        injectInto: 'infovis',
        //Enable zooming and panning
        //by scrolling and DnD
        Navigation: {
          enable: true,
          //Enable panning events only if we're dragging the empty
          //canvas (and not a node).
          panning: 'avoid nodes',
          zooming: 10 //zoom speed. higher is more sensible
        },
        // Change node and edge styles such as
        // color and width.
        // These properties are also set per node
        // with dollar prefixed data-properties in the
        // JSON structure.
        Node: {
          overridable: true,
          color: "#83548B",
          dim:1
        },
        Edge: {
          overridable: true,
          color: '#23A4FF',
          lineWidth: 2
        },
        //Native canvas text styling
        Label: {
          type: 'HTML', //Native or HTML
          size: 10,
          style: 'bold'

        },
        //Add Tips
        Tips: {
          enable: false,
          *{onShow: function(tip, node) {
            //count connections
            var count = 0;
            node.eachAdjacency(function() { count++; });
            //display node info in tooltip
            tip.innerHTML = '<div class="tip-title">' + node.name + '</div>'
              + '<div class="tip-text"><b>connections:</b> ' + count + '</div>';
          }}*
        },
        // Add node events
        Events: {
          enable: true,
          //Change cursor style when hovering a node
          onMouseEnter: function() {
            fd.canvas.getElement().style.cursor = 'move';
          },
          onMouseLeave: function() {
            fd.canvas.getElement().style.cursor = '';
          },
          //Update node positions when dragged
          onDragMove: function(node, eventInfo, e) {
              jQuery("#radial_menu").radmenu("hide");
              var pos = eventInfo.getPos();
              var oldx = node.pos.x;
              var oldy = node.pos.y;
              node.pos.setc(pos.x, pos.y);
              node.setPos(new $jit.Complex(pos.x, pos.y), 'end');
              function moveSubnode(subnode) {
                var newx = subnode.pos.x + pos.x - oldx;
                var newy = subnode.pos.y + pos.y - oldy;
                subnode.pos.setc(newx, newy);
                subnode.setPos(new $jit.Complex(newx, newy), 'end');
                if (subnode.getSubnodes().length > 0) {
                    subnode.eachSubnode(moveSubnode);
                }
              }
              node.eachSubnode(moveSubnode);
              fd.plot();
          },
          //Implement the same handler for touchscreens
          onTouchMove: function(node, eventInfo, e) {
            $jit.util.event.stop(e); //stop default touchmove event
            this.onDragMove(node, eventInfo, e);
          },
          //Add also a click handler to nodes
          onClick: function(node){
            if(node){
              if (relationFromNode) {
                $.post(addRelation({fromId: relationFromNode.id, toID: node.id}));
                relationFromNode = null;
              }
              else {
              defaultEdgesForSelectedNode(selectedNode);
              show_radial_menu(node);
              node.eachAdjacency(function(adj) {
                adj.setDataset('current', {
                  lineWidth: '5',
                  color: '#FF0000'
                });
              });
              fd.plot();
              }
            }else{
              defaultEdgesForSelectedNode(selectedNode);
              jQuery("#radial_menu").radmenu("hide");
              fd.plot();
            }
          }
        },
        //Number of iterations for the FD algorithm
        iterations: 4,
        //Edge length
        levelDistance: 130,
        // Add text to the labels. This method is only triggered
        // on label creation and only for DOM labels (not native canvas ones).
        onCreateLabel: function(domElement, node){
          var nameContainer = document.createElement('span');
          nameContainer.className = 'name';
          nameContainer.innerHTML = '<div class="nodeBox" id='+node.id+'>'+node.name+'</div>';
          domElement.appendChild(nameContainer);
          var style = domElement.style;
          style.fontSize = "0.8em";
          style.color = "#ddd";
        },
        // Change node styles when DOM labels are placed
        // or moved.
        onPlaceLabel: function(domElement, node){
          var style = domElement.style;
          var left = parseInt(style.left);
          var top = parseInt(style.top);
          var w = domElement.offsetWidth;
          style.left = (left - w / 2) + 'px';
          style.top = (top-18) + 'px';
          style.display = '';
        }
      });
      var getNodes = function() {
          $.ajax({
                url: waitMessages({lastReceived: lastReceived}),
                success: function(events) {
                    $(events).each(function() {
                        if (this.data.type === 'deletecauseevent') {
                          fd.graph.removeNode(this.data.causeId);
                          fd.plot();
                          $("div.node#" + this.data.causeId).remove();
                        }
                        if (this.data.type === 'addrelationevent') {
                          //alert(this.data.causeFrom + " " + this.data.causeTo);
                          fd.graph.addAdjacence(fd.graph.getNode(this.data.causeFrom), fd.graph.getNode(this.data.causeTo));
                          fd.plot();
                        }
                        else if(this.data.type === 'addcauseevent') {
                          var newNode = {
                            "id": this.data.causeTo,
                            "name": this.data.text
                          };
                          var node = {
                            "id": this.data.causeFrom,
                            "name": this.data.text
                          };
                          fd.graph.addAdjacence(node,newNode);
                          var nodePos = fd.graph.getNode(this.data.causeFrom).getPos();
                          fd.graph.getNode(this.data.causeTo).setPos(new $jit.Complex(nodePos.x, nodePos.y), 'current');
                          fd.graph.getNode(this.data.causeTo).setPos(new $jit.Complex(nodePos.x, nodePos.y+100), 'end');

                          fd.animate({
                                modes: ['linear'],
                                transition: $jit.Trans.Elastic.easeOut,
                                duration: 1500
                              });
                          *{fd.computeIncremental({
                            iter: 5,
                            property: 'end',
                            onStep: function(perc){
                            },
                            onComplete: function(){
                              fd.animate({
                                modes: ['linear'],
                                transition: $jit.Trans.Elastic.easeOut,
                                duration: 1200
                              });
                            }
                          });}*
                        }
                        lastReceived = this.id
                    })
                    getNodes()
                },
                dataType: 'json'
          });
      }
      getNodes();

      // load JSON data.
      fd.loadJSON(json);
      // compute positions incrementally and animate.
      fd.computeIncremental({
        iter: 40,
        property: 'end',
        onStep: function(perc){
        },
        onComplete: function(){
          fd.animate({
            modes: ['linear'],
            transition: $jit.Trans.Elastic.easeOut,
            duration: 50
          });
          fd.plot();
        }
      });
      // end

    }

    radmenu_fadeIn = function() {
        jQuery("#radial_menu").radmenu("show",
            function(items){
            items.fadeIn(400);
            }
        );
    }

    radmenu_fadeOut = function() {
        jQuery("#radial_menu").radmenu("show",
            function(items){
            items.fadeOut(4000);
            }
        );
    }

    defaultEdgesForSelectedNode = function(selectedNode) {
      if (selectedNode != undefined) {
        selectedNode.eachAdjacency(function(adj) {
          adj.setDataset('current', {
            lineWidth: '2',
            color: '#23A4FF'
          });
        });
      }
    }
    
</script>
    </body>
</html>

